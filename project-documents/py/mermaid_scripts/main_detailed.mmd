flowchart TD
    %% Level 2 Abstraction: Main Execution Logic
    subgraph Context [Global Context]
        Config[Load Config] --> Flags[Set Feature Flags]
        Flags --> InitVars[Initialize Variables to None]
    end

    subgraph DataPhase [Phase 1: Data Ingestion]
        InitVars --> CleanOut["clean_outputs()"]
        CleanOut --> CheckData{ENABLE_DATA_PROCESSING?}
        CheckData -- No --> CheckTS
        CheckData -- Yes --> Download["download_required_files()"]
        Download --> Load["df = load_and_explore_data()"]
        Load --> Preprocess["df_clean = preprocess_data(df)"]
        Preprocess --> CheckEDA{ENABLE_EXPLORATORY_ANALYSIS?}
        CheckEDA -- Yes --> RunEDA["exploratory_data_analysis()"]
        CheckEDA -- No --> CheckTS
        RunEDA --> CheckTS
    end

    subgraph AnalysisPhase [Phase 2: Aggregation & Forecasting]
        CheckTS{ENABLE_TIME_SERIES?} -- Yes --> Agg["aggregate_time_series()"]
        Agg --> OutAgg[Returns: df_yearly, ts_data, df_model_yearly, df_region_yearly]
        OutAgg --> CheckStatic
        CheckTS -- No --> CheckStatic

        CheckStatic{ENABLE_STATIC_PLOTS?} -- Yes --> GenStatic["create_overview_visualizations()"]
        GenStatic --> GenHeatmap["create_heatmap()"]
        GenHeatmap --> CheckARIMA
        CheckStatic -- No --> CheckARIMA

        CheckARIMA{ENABLE_ARIMA_FORECAST?} -- Yes --> RunARIMA["forecast_with_arima()"]
        RunARIMA --> OutARIMA[Returns: forecast_values, future_values, CI]
        OutARIMA --> VizForecast["visualize_forecast()"]
        VizForecast --> CheckModelCast
        CheckARIMA -- No --> CheckModelCast
    end

    subgraph ModelPhase [Phase 3: Model Specifics]
        CheckModelCast{ENABLE_MODEL_FORECASTS?} -- Yes --> IDTop5[Identify Top 5 Models]
        IDTop5 --> CalcModels["calculate_model_forecasts()"]
        CalcModels --> OutModels[Returns: model_forecasts Dict]
        OutModels --> PlotModels["plot_model_forecasts()"]
        PlotModels --> CheckAlerts
        CheckModelCast -- No --> CheckAlerts
    end

    subgraph AlertPhase [Phase 4: Alerting Logic]
        CheckAlerts{ENABLE_ALERTS?} -- Yes --> SetupAlerts["setup_alert_system()"]
        SetupAlerts --> CalcThresh[Calculate Thresholds]
        CalcThresh --> RunChecks["run_alert_checks()"]
        RunChecks --> GenReport["generate_alert_report()"]
        
        GenReport --> CheckTest{TEST_MODE?}
        CheckTest -- Yes --> Inject["inject_test_metrics()"]
        Inject --> RerunChecks["Re-run run_alert_checks()"]
        RerunChecks --> GenReport2[Regenerate Report]
        GenReport2 --> CheckReporting
        CheckTest -- No --> CheckReporting
        CheckAlerts -- No --> CheckReporting
    end

    subgraph FinalPhase [Phase 5: Reporting & Export]
        CheckReporting{ENABLE_REPORTING?} -- Yes --> GenMonthly["generate_monthly_report()"]
        GenMonthly --> SaveReport[Save .txt]
        SaveReport --> CheckDash
        
        CheckDash{ENABLE_DASHBOARDS?} -- Yes --> Dash1["create_interactive_dashboard()"]
        Dash1 --> Dash2["create_heatmap_interactive()"]
        Dash2 --> CheckExport
        
        CheckExport{ENABLE_EXPORTS?} -- Yes --> ExportData["export_data()"]
        ExportData --> CheckAgg
        
        CheckAgg{ENABLE_AGGREGATOR?} -- Yes --> AggHTML["create_aggregator_html()"]
        AggHTML --> Zip["zip_all_outputs()"]
        Zip --> End([End Execution])
    end